<span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><a name="l1" /></span><span style="color: #FF8000">/**<br /><a name="l2" />&nbsp;*&nbsp;This&nbsp;file&nbsp;is&nbsp;part&nbsp;of&nbsp;escpos-php:&nbsp;PHP&nbsp;receipt&nbsp;printer&nbsp;library&nbsp;for&nbsp;use&nbsp;with<br /><a name="l3" />&nbsp;*&nbsp;ESC/POS-compatible&nbsp;thermal&nbsp;and&nbsp;impact&nbsp;printers.<br /><a name="l4" />&nbsp;*<br /><a name="l5" />&nbsp;*&nbsp;Copyright&nbsp;(c)&nbsp;2014-16&nbsp;Michael&nbsp;Billington&nbsp;&lt;&nbsp;michael.billington@gmail.com&nbsp;&gt;,<br /><a name="l6" />&nbsp;*&nbsp;incorporating&nbsp;modifications&nbsp;by&nbsp;others.&nbsp;See&nbsp;CONTRIBUTORS.md&nbsp;for&nbsp;a&nbsp;full&nbsp;list.<br /><a name="l7" />&nbsp;*<br /><a name="l8" />&nbsp;*&nbsp;This&nbsp;software&nbsp;is&nbsp;distributed&nbsp;under&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;MIT&nbsp;license.&nbsp;See&nbsp;LICENSE.md<br /><a name="l9" />&nbsp;*&nbsp;for&nbsp;details.<br /><a name="l10" />&nbsp;*/<br /><a name="l11" /><br /><a name="l12" /></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">Mike42</span><span style="color: #007700">\</span><span style="color: #0000BB">Escpos</span><span style="color: #007700">\</span><span style="color: #0000BB">PrintConnectors</span><span style="color: #007700">;<br /><a name="l13" /><br /><a name="l14" />use&nbsp;</span><span style="color: #0000BB">Exception</span><span style="color: #007700">;<br /><a name="l15" />use&nbsp;</span><span style="color: #0000BB">BadMethodCallException</span><span style="color: #007700">;<br /><a name="l16" /><br /><a name="l17" /></span><span style="color: #FF8000">/**<br /><a name="l18" />&nbsp;*&nbsp;Print&nbsp;connector&nbsp;that&nbsp;passes&nbsp;print&nbsp;data&nbsp;to&nbsp;CUPS&nbsp;print&nbsp;commands.<br /><a name="l19" />&nbsp;*&nbsp;Your&nbsp;printer&nbsp;mut&nbsp;be&nbsp;installed&nbsp;on&nbsp;the&nbsp;local&nbsp;CUPS&nbsp;instance&nbsp;to&nbsp;use&nbsp;this&nbsp;connector.<br /><a name="l20" />&nbsp;*/<br /><a name="l21" /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">CupsPrintConnector&nbsp;</span><span style="color: #007700">implements&nbsp;</span><span style="color: #0000BB">PrintConnector<br /><a name="l22" /></span><span style="color: #007700">{<br /><a name="l23" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l24" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l25" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;array&nbsp;$buffer<br /><a name="l26" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Buffer&nbsp;of&nbsp;accumilated&nbsp;data.<br /><a name="l27" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l28" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$buffer</span><span style="color: #007700">;<br /><a name="l29" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l30" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l31" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l32" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string&nbsp;$printerName<br /><a name="l33" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;target&nbsp;printer.<br /><a name="l34" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l35" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$printerName</span><span style="color: #007700">;<br /><a name="l36" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l37" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l38" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Construct&nbsp;new&nbsp;CUPS&nbsp;print&nbsp;connector.<br /><a name="l39" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l40" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$dest<br /><a name="l41" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;CUPS&nbsp;printer&nbsp;name&nbsp;to&nbsp;print&nbsp;to.&nbsp;This&nbsp;must&nbsp;be&nbsp;loaded&nbsp;using&nbsp;a&nbsp;raw&nbsp;driver.<br /><a name="l42" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;BadMethodCallException<br /><a name="l43" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l44" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">__construct</span><span style="color: #007700">(</span><span style="color: #0000BB">$dest</span><span style="color: #007700">)<br /><a name="l45" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l46" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$valid&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getLocalPrinters</span><span style="color: #007700">();<br /><a name="l47" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$valid</span><span style="color: #007700">)&nbsp;==&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&nbsp;{<br /><a name="l48" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000BB">BadMethodCallException</span><span style="color: #007700">(</span><span style="color: #DD0000">"You&nbsp;do&nbsp;not&nbsp;have&nbsp;any&nbsp;printers&nbsp;installed&nbsp;on&nbsp;"&nbsp;</span><span style="color: #007700">.<br /><a name="l49" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"this&nbsp;system&nbsp;via&nbsp;CUPS.&nbsp;Check&nbsp;'lpr&nbsp;-a'."</span><span style="color: #007700">);<br /><a name="l50" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l51" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l52" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">array_search</span><span style="color: #007700">(</span><span style="color: #0000BB">$dest</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$valid</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">)&nbsp;===&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">)&nbsp;{<br /><a name="l53" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000BB">BadMethodCallException</span><span style="color: #007700">(</span><span style="color: #DD0000">"'</span><span style="color: #0000BB">$dest</span><span style="color: #DD0000">'&nbsp;is&nbsp;not&nbsp;a&nbsp;printer&nbsp;on&nbsp;this&nbsp;system.&nbsp;"&nbsp;</span><span style="color: #007700">.<br /><a name="l54" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"Printers&nbsp;are:&nbsp;["&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">implode</span><span style="color: #007700">(</span><span style="color: #DD0000">",&nbsp;"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$valid</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"]"</span><span style="color: #007700">);<br /><a name="l55" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l56" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">buffer&nbsp;</span><span style="color: #007700">=&nbsp;array&nbsp;();<br /><a name="l57" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">printerName&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$dest</span><span style="color: #007700">;<br /><a name="l58" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l59" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l60" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l61" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Cause&nbsp;a&nbsp;NOTICE&nbsp;if&nbsp;deconstructed&nbsp;before&nbsp;the&nbsp;job&nbsp;was&nbsp;printed.<br /><a name="l62" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l63" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">__destruct</span><span style="color: #007700">()<br /><a name="l64" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l65" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">buffer&nbsp;</span><span style="color: #007700">!==&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br /><a name="l66" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">trigger_error</span><span style="color: #007700">(</span><span style="color: #DD0000">"Print&nbsp;connector&nbsp;was&nbsp;not&nbsp;finalized.&nbsp;Did&nbsp;you&nbsp;forget&nbsp;to&nbsp;close&nbsp;the&nbsp;printer?"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">E_USER_NOTICE</span><span style="color: #007700">);<br /><a name="l67" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l68" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l69" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l70" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l71" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Send&nbsp;job&nbsp;to&nbsp;printer.<br /><a name="l72" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l73" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">finalize</span><span style="color: #007700">()<br /><a name="l74" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l75" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$data&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">implode</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">buffer</span><span style="color: #007700">);<br /><a name="l76" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">buffer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l77" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l78" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Build&nbsp;command&nbsp;to&nbsp;work&nbsp;on&nbsp;data<br /><a name="l79" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$tmpfname&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">tempnam</span><span style="color: #007700">(</span><span style="color: #0000BB">sys_get_temp_dir</span><span style="color: #007700">(),&nbsp;</span><span style="color: #DD0000">'print-'</span><span style="color: #007700">);<br /><a name="l80" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">file_put_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$tmpfname</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br /><a name="l81" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$cmd&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(<br /><a name="l82" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"lp&nbsp;-d&nbsp;%s&nbsp;%s"</span><span style="color: #007700">,<br /><a name="l83" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">printerName</span><span style="color: #007700">),<br /><a name="l84" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$tmpfname</span><span style="color: #007700">)<br /><a name="l85" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l86" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br /><a name="l87" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getCmdOutput</span><span style="color: #007700">(</span><span style="color: #0000BB">$cmd</span><span style="color: #007700">);<br /><a name="l88" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(</span><span style="color: #0000BB">Exception&nbsp;$e</span><span style="color: #007700">)&nbsp;{<br /><a name="l89" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$tmpfname</span><span style="color: #007700">);<br /><a name="l90" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;</span><span style="color: #0000BB">$e</span><span style="color: #007700">;<br /><a name="l91" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l92" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$tmpfname</span><span style="color: #007700">);<br /><a name="l93" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l94" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l95" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l96" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Run&nbsp;a&nbsp;command&nbsp;and&nbsp;throw&nbsp;an&nbsp;exception&nbsp;if&nbsp;it&nbsp;fails,&nbsp;or&nbsp;return&nbsp;the&nbsp;output&nbsp;if&nbsp;it&nbsp;works.<br /><a name="l97" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;(Basically&nbsp;exec()&nbsp;with&nbsp;good&nbsp;error&nbsp;handling)<br /><a name="l98" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l99" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$cmd<br /><a name="l100" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Command&nbsp;to&nbsp;run<br /><a name="l101" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l102" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">protected&nbsp;function&nbsp;</span><span style="color: #0000BB">getCmdOutput</span><span style="color: #007700">(</span><span style="color: #0000BB">$cmd</span><span style="color: #007700">)<br /><a name="l103" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l104" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$descriptors&nbsp;</span><span style="color: #007700">=&nbsp;array&nbsp;(<br /><a name="l105" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">1&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array&nbsp;(<br /><a name="l106" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"pipe"</span><span style="color: #007700">,<br /><a name="l107" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"w"<br /><a name="l108" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">),<br /><a name="l109" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">2&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array&nbsp;(<br /><a name="l110" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"pipe"</span><span style="color: #007700">,<br /><a name="l111" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"w"<br /><a name="l112" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">)<br /><a name="l113" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l114" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$process&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">proc_open</span><span style="color: #007700">(</span><span style="color: #0000BB">$cmd</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$descriptors</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">);<br /><a name="l115" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!&nbsp;</span><span style="color: #0000BB">is_resource</span><span style="color: #007700">(</span><span style="color: #0000BB">$process</span><span style="color: #007700">))&nbsp;{<br /><a name="l116" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000BB">Exception</span><span style="color: #007700">(</span><span style="color: #DD0000">"Command&nbsp;'</span><span style="color: #0000BB">$cmd</span><span style="color: #DD0000">'&nbsp;failed&nbsp;to&nbsp;start."</span><span style="color: #007700">);<br /><a name="l117" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l118" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Read&nbsp;stdout&nbsp;*/<br /><a name="l119" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$outputStr&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">stream_get_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$fd&nbsp;</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">]);<br /><a name="l120" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fd&nbsp;</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">]);<br /><a name="l121" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Read&nbsp;stderr&nbsp;*/<br /><a name="l122" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$errorStr&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">stream_get_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$fd&nbsp;</span><span style="color: #007700">[</span><span style="color: #0000BB">2</span><span style="color: #007700">]);<br /><a name="l123" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fd&nbsp;</span><span style="color: #007700">[</span><span style="color: #0000BB">2</span><span style="color: #007700">]);<br /><a name="l124" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Finish&nbsp;up&nbsp;*/<br /><a name="l125" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$retval&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">proc_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$process</span><span style="color: #007700">);<br /><a name="l126" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$retval&nbsp;</span><span style="color: #007700">!=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&nbsp;{<br /><a name="l127" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000BB">Exception</span><span style="color: #007700">(</span><span style="color: #DD0000">"Command&nbsp;</span><span style="color: #0000BB">$cmd</span><span style="color: #DD0000">&nbsp;failed:&nbsp;</span><span style="color: #0000BB">$errorStr</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br /><a name="l128" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l129" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$outputStr</span><span style="color: #007700">;<br /><a name="l130" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l131" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l132" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l133" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Read&nbsp;data&nbsp;from&nbsp;the&nbsp;printer.<br /><a name="l134" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l135" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$len&nbsp;Length&nbsp;of&nbsp;data&nbsp;to&nbsp;read.<br /><a name="l136" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;Data&nbsp;read&nbsp;from&nbsp;the&nbsp;printer,&nbsp;or&nbsp;false&nbsp;where&nbsp;reading&nbsp;is&nbsp;not&nbsp;possible.<br /><a name="l137" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l138" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">read</span><span style="color: #007700">(</span><span style="color: #0000BB">$len</span><span style="color: #007700">)<br /><a name="l139" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l140" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">;<br /><a name="l141" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l142" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l143" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l144" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data<br /><a name="l145" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l146" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">write</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">)<br /><a name="l147" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l148" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">buffer&nbsp;</span><span style="color: #007700">[]&nbsp;=&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">;<br /><a name="l149" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l150" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l151" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l152" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Load&nbsp;a&nbsp;list&nbsp;of&nbsp;CUPS&nbsp;printers.<br /><a name="l153" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l154" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;array&nbsp;A&nbsp;list&nbsp;of&nbsp;printer&nbsp;names&nbsp;installed&nbsp;on&nbsp;this&nbsp;system.&nbsp;Any&nbsp;item<br /><a name="l155" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;on&nbsp;this&nbsp;list&nbsp;is&nbsp;valid&nbsp;for&nbsp;constructing&nbsp;a&nbsp;printer.<br /><a name="l156" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l157" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">protected&nbsp;function&nbsp;</span><span style="color: #0000BB">getLocalPrinters</span><span style="color: #007700">()<br /><a name="l158" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l159" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$outpStr&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getCmdOutput</span><span style="color: #007700">(</span><span style="color: #DD0000">"lpstat&nbsp;-a"</span><span style="color: #007700">);<br /><a name="l160" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$outpLines&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">explode</span><span style="color: #007700">(</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">trim</span><span style="color: #007700">(</span><span style="color: #0000BB">$outpStr</span><span style="color: #007700">));<br /><a name="l161" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">$outpLines&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$line</span><span style="color: #007700">)&nbsp;{<br /><a name="l162" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">[]&nbsp;=&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">chopLpstatLine</span><span style="color: #007700">(</span><span style="color: #0000BB">$line</span><span style="color: #007700">);<br /><a name="l163" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l164" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">;<br /><a name="l165" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l166" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l167" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l168" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Get&nbsp;the&nbsp;item&nbsp;before&nbsp;the&nbsp;first&nbsp;space&nbsp;in&nbsp;a&nbsp;string<br /><a name="l169" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l170" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$line<br /><a name="l171" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string&nbsp;the&nbsp;string,&nbsp;up&nbsp;to&nbsp;the&nbsp;first&nbsp;space,&nbsp;or&nbsp;the&nbsp;whole&nbsp;string&nbsp;if&nbsp;it&nbsp;contains&nbsp;no&nbsp;spaces.<br /><a name="l172" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l173" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;function&nbsp;</span><span style="color: #0000BB">chopLpstatLine</span><span style="color: #007700">(</span><span style="color: #0000BB">$line</span><span style="color: #007700">)<br /><a name="l174" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l175" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((</span><span style="color: #0000BB">$pos&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">strpos</span><span style="color: #007700">(</span><span style="color: #0000BB">$line</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"&nbsp;"</span><span style="color: #007700">))&nbsp;===&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">)&nbsp;{<br /><a name="l176" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$line</span><span style="color: #007700">;<br /><a name="l177" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><a name="l178" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$line</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$pos</span><span style="color: #007700">);<br /><a name="l179" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l180" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l181" />}<br /><a name="l182" /></span>
</span>