<span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><a name="l1" /></span><span style="color: #FF8000">/**<br /><a name="l2" />&nbsp;*&nbsp;This&nbsp;file&nbsp;is&nbsp;part&nbsp;of&nbsp;escpos-php:&nbsp;PHP&nbsp;receipt&nbsp;printer&nbsp;library&nbsp;for&nbsp;use&nbsp;with<br /><a name="l3" />&nbsp;*&nbsp;ESC/POS-compatible&nbsp;thermal&nbsp;and&nbsp;impact&nbsp;printers.<br /><a name="l4" />&nbsp;*<br /><a name="l5" />&nbsp;*&nbsp;Copyright&nbsp;(c)&nbsp;2014-16&nbsp;Michael&nbsp;Billington&nbsp;&lt;&nbsp;michael.billington@gmail.com&nbsp;&gt;,<br /><a name="l6" />&nbsp;*&nbsp;incorporating&nbsp;modifications&nbsp;by&nbsp;others.&nbsp;See&nbsp;CONTRIBUTORS.md&nbsp;for&nbsp;a&nbsp;full&nbsp;list.<br /><a name="l7" />&nbsp;*<br /><a name="l8" />&nbsp;*&nbsp;This&nbsp;software&nbsp;is&nbsp;distributed&nbsp;under&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;MIT&nbsp;license.&nbsp;See&nbsp;LICENSE.md<br /><a name="l9" />&nbsp;*&nbsp;for&nbsp;details.<br /><a name="l10" />&nbsp;*/<br /><a name="l11" /><br /><a name="l12" /></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">Mike42</span><span style="color: #007700">\</span><span style="color: #0000BB">Escpos</span><span style="color: #007700">\</span><span style="color: #0000BB">PrintConnectors</span><span style="color: #007700">;<br /><a name="l13" /><br /><a name="l14" />use&nbsp;</span><span style="color: #0000BB">Exception</span><span style="color: #007700">;<br /><a name="l15" />use&nbsp;</span><span style="color: #0000BB">BadMethodCallException</span><span style="color: #007700">;<br /><a name="l16" /><br /><a name="l17" /></span><span style="color: #FF8000">/**<br /><a name="l18" />&nbsp;*&nbsp;Connector&nbsp;for&nbsp;sending&nbsp;print&nbsp;jobs&nbsp;to<br /><a name="l19" />&nbsp;*&nbsp;-&nbsp;local&nbsp;ports&nbsp;on&nbsp;windows&nbsp;(COM1,&nbsp;LPT1,&nbsp;etc)<br /><a name="l20" />&nbsp;*&nbsp;-&nbsp;shared&nbsp;(SMB)&nbsp;printers&nbsp;from&nbsp;any&nbsp;platform&nbsp;(smb://server/foo)<br /><a name="l21" />&nbsp;*&nbsp;For&nbsp;USB&nbsp;printers&nbsp;or&nbsp;other&nbsp;ports,&nbsp;the&nbsp;trick&nbsp;is&nbsp;to&nbsp;share&nbsp;the&nbsp;printer&nbsp;with&nbsp;a<br /><a name="l22" />&nbsp;*&nbsp;generic&nbsp;text&nbsp;driver,&nbsp;then&nbsp;connect&nbsp;to&nbsp;the&nbsp;shared&nbsp;printer&nbsp;locally.<br /><a name="l23" />&nbsp;*/<br /><a name="l24" /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">WindowsPrintConnector&nbsp;</span><span style="color: #007700">implements&nbsp;</span><span style="color: #0000BB">PrintConnector<br /><a name="l25" /></span><span style="color: #007700">{<br /><a name="l26" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l27" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;array&nbsp;$buffer<br /><a name="l28" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Accumulated&nbsp;lines&nbsp;of&nbsp;output&nbsp;for&nbsp;later&nbsp;use.<br /><a name="l29" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l30" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$buffer</span><span style="color: #007700">;<br /><a name="l31" /><br /><a name="l32" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l33" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string&nbsp;$hostname<br /><a name="l34" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;The&nbsp;hostname&nbsp;of&nbsp;the&nbsp;target&nbsp;machine,&nbsp;or&nbsp;null&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;local&nbsp;connection.<br /><a name="l35" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l36" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$hostname</span><span style="color: #007700">;<br /><a name="l37" /><br /><a name="l38" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l39" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;boolean&nbsp;$isLocal<br /><a name="l40" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;True&nbsp;if&nbsp;a&nbsp;port&nbsp;is&nbsp;being&nbsp;used&nbsp;directly&nbsp;(must&nbsp;be&nbsp;Windows),&nbsp;false&nbsp;if&nbsp;network&nbsp;shares&nbsp;will&nbsp;be&nbsp;used.<br /><a name="l41" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l42" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$isLocal</span><span style="color: #007700">;<br /><a name="l43" /><br /><a name="l44" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l45" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;int&nbsp;$platform<br /><a name="l46" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Platform&nbsp;we're&nbsp;running&nbsp;on,&nbsp;for&nbsp;selecting&nbsp;different&nbsp;commands.&nbsp;See&nbsp;PLATFORM_*&nbsp;constants.<br /><a name="l47" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l48" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$platform</span><span style="color: #007700">;<br /><a name="l49" /><br /><a name="l50" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l51" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string&nbsp;$printerName<br /><a name="l52" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;target&nbsp;printer&nbsp;(eg&nbsp;"Foo&nbsp;Printer")&nbsp;or&nbsp;port&nbsp;("COM1",&nbsp;"LPT1").<br /><a name="l53" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l54" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$printerName</span><span style="color: #007700">;<br /><a name="l55" /><br /><a name="l56" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l57" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string&nbsp;$userName<br /><a name="l58" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Login&nbsp;name&nbsp;for&nbsp;network&nbsp;printer,&nbsp;or&nbsp;null&nbsp;if&nbsp;not&nbsp;using&nbsp;authentication.<br /><a name="l59" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l60" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$userName</span><span style="color: #007700">;<br /><a name="l61" /><br /><a name="l62" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l63" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string&nbsp;$userPassword<br /><a name="l64" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Password&nbsp;for&nbsp;network&nbsp;printer,&nbsp;or&nbsp;null&nbsp;if&nbsp;no&nbsp;password&nbsp;is&nbsp;required.<br /><a name="l65" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l66" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$userPassword</span><span style="color: #007700">;<br /><a name="l67" /><br /><a name="l68" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l69" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@var&nbsp;string&nbsp;$workgroup<br /><a name="l70" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Workgroup&nbsp;that&nbsp;the&nbsp;printer&nbsp;is&nbsp;located&nbsp;on<br /><a name="l71" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l72" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">private&nbsp;</span><span style="color: #0000BB">$workgroup</span><span style="color: #007700">;<br /><a name="l73" /><br /><a name="l74" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l75" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Represents&nbsp;Linux<br /><a name="l76" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l77" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">const&nbsp;</span><span style="color: #0000BB">PLATFORM_LINUX&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br /><a name="l78" /><br /><a name="l79" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l80" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Represents&nbsp;Mac<br /><a name="l81" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l82" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">const&nbsp;</span><span style="color: #0000BB">PLATFORM_MAC&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">;<br /><a name="l83" /><br /><a name="l84" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l85" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Represents&nbsp;Windows<br /><a name="l86" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l87" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">const&nbsp;</span><span style="color: #0000BB">PLATFORM_WIN&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">2</span><span style="color: #007700">;<br /><a name="l88" /><br /><a name="l89" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l90" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Valid&nbsp;local&nbsp;ports.<br /><a name="l91" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l92" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">const&nbsp;</span><span style="color: #0000BB">REGEX_LOCAL&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"/^(LPT\d|COM\d)$/"</span><span style="color: #007700">;<br /><a name="l93" /><br /><a name="l94" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l95" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Valid&nbsp;printer&nbsp;name.<br /><a name="l96" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l97" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">const&nbsp;</span><span style="color: #0000BB">REGEX_PRINTERNAME&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"/^[\d\w-]+(\s[\d\w-]+)*$/"</span><span style="color: #007700">;<br /><a name="l98" /><br /><a name="l99" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l100" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Valid&nbsp;smb://&nbsp;URI&nbsp;containing&nbsp;hostname&nbsp;&amp;&nbsp;printer&nbsp;with&nbsp;optional&nbsp;user&nbsp;&amp;&nbsp;optional&nbsp;password&nbsp;only.<br /><a name="l101" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l102" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">const&nbsp;</span><span style="color: #0000BB">REGEX_SMB&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"/^smb:\/\/([\s\d\w-]+(:[\s\d\w-]+)?@)?([\d\w-]+\.)*[\d\w-]+\/([\d\w-]+\/)?[\d\w-]+(\s[\d\w-]+)*$/"</span><span style="color: #007700">;<br /><a name="l103" /><br /><a name="l104" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l105" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$dest<br /><a name="l106" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;BadMethodCallException<br /><a name="l107" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l108" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">__construct</span><span style="color: #007700">(</span><span style="color: #0000BB">$dest</span><span style="color: #007700">)<br /><a name="l109" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l110" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">platform&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">getCurrentPlatform</span><span style="color: #007700">();<br /><a name="l111" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">isLocal&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">;<br /><a name="l112" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">buffer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l113" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">userName&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l114" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">userPassword&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l115" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">workgroup&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l116" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">preg_match</span><span style="color: #007700">(</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">REGEX_LOCAL</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$dest</span><span style="color: #007700">)&nbsp;==&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">)&nbsp;{<br /><a name="l117" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Straight&nbsp;to&nbsp;LPT1,&nbsp;COM1&nbsp;or&nbsp;other&nbsp;local&nbsp;port.&nbsp;Allowed&nbsp;only&nbsp;if&nbsp;we&nbsp;are&nbsp;actually&nbsp;on&nbsp;windows.<br /><a name="l118" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">platform&nbsp;</span><span style="color: #007700">!==&nbsp;</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">PLATFORM_WIN</span><span style="color: #007700">)&nbsp;{<br /><a name="l119" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000BB">BadMethodCallException</span><span style="color: #007700">(</span><span style="color: #DD0000">"WindowsPrintConnector&nbsp;can&nbsp;only&nbsp;be&nbsp;"&nbsp;</span><span style="color: #007700">.<br /><a name="l120" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"used&nbsp;to&nbsp;print&nbsp;to&nbsp;a&nbsp;local&nbsp;printer&nbsp;('"</span><span style="color: #007700">.</span><span style="color: #0000BB">$dest</span><span style="color: #007700">.</span><span style="color: #DD0000">"')&nbsp;on&nbsp;a&nbsp;Windows&nbsp;computer."</span><span style="color: #007700">);<br /><a name="l121" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l122" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">isLocal&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br /><a name="l123" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">hostname&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l124" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">printerName&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$dest</span><span style="color: #007700">;<br /><a name="l125" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(</span><span style="color: #0000BB">preg_match</span><span style="color: #007700">(</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">REGEX_SMB</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$dest</span><span style="color: #007700">)&nbsp;==&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">)&nbsp;{<br /><a name="l126" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Connect&nbsp;to&nbsp;samba&nbsp;share,&nbsp;eg&nbsp;smb://host/printer<br /><a name="l127" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$part&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">parse_url</span><span style="color: #007700">(</span><span style="color: #0000BB">$dest</span><span style="color: #007700">);<br /><a name="l128" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">hostname&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$part</span><span style="color: #007700">[</span><span style="color: #DD0000">'host'</span><span style="color: #007700">];<br /><a name="l129" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Printer&nbsp;name&nbsp;and&nbsp;optional&nbsp;workgroup&nbsp;*/<br /><a name="l130" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$path&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">ltrim</span><span style="color: #007700">(</span><span style="color: #0000BB">$part</span><span style="color: #007700">[</span><span style="color: #DD0000">'path'</span><span style="color: #007700">],&nbsp;</span><span style="color: #DD0000">'/'</span><span style="color: #007700">);<br /><a name="l131" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">strpos</span><span style="color: #007700">(</span><span style="color: #0000BB">$path</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"/"</span><span style="color: #007700">)&nbsp;!==&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">)&nbsp;{<br /><a name="l132" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$pathPart&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">explode</span><span style="color: #007700">(</span><span style="color: #DD0000">"/"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$path</span><span style="color: #007700">);<br /><a name="l133" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">workgroup&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$pathPart</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br /><a name="l134" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">printerName&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$pathPart</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">];<br /><a name="l135" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><a name="l136" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">printerName&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$path</span><span style="color: #007700">;<br /><a name="l137" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l138" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Username&nbsp;and&nbsp;password&nbsp;if&nbsp;set&nbsp;*/<br /><a name="l139" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(isset(</span><span style="color: #0000BB">$part</span><span style="color: #007700">[</span><span style="color: #DD0000">'user'</span><span style="color: #007700">]))&nbsp;{<br /><a name="l140" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">userName&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$part</span><span style="color: #007700">[</span><span style="color: #DD0000">'user'</span><span style="color: #007700">];<br /><a name="l141" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset(</span><span style="color: #0000BB">$part</span><span style="color: #007700">[</span><span style="color: #DD0000">'pass'</span><span style="color: #007700">]))&nbsp;{<br /><a name="l142" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">userPassword&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$part</span><span style="color: #007700">[</span><span style="color: #DD0000">'pass'</span><span style="color: #007700">];<br /><a name="l143" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l144" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l145" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(</span><span style="color: #0000BB">preg_match</span><span style="color: #007700">(</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">REGEX_PRINTERNAME</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$dest</span><span style="color: #007700">)&nbsp;==&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">)&nbsp;{<br /><a name="l146" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Just&nbsp;got&nbsp;a&nbsp;printer&nbsp;name.&nbsp;Assume&nbsp;it's&nbsp;on&nbsp;the&nbsp;current&nbsp;computer.<br /><a name="l147" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$hostname&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">gethostname</span><span style="color: #007700">();<br /><a name="l148" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000BB">$hostname</span><span style="color: #007700">)&nbsp;{<br /><a name="l149" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$hostname&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">;<br /><a name="l150" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l151" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">hostname&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$hostname</span><span style="color: #007700">;<br /><a name="l152" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">printerName&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$dest</span><span style="color: #007700">;<br /><a name="l153" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><a name="l154" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000BB">BadMethodCallException</span><span style="color: #007700">(</span><span style="color: #DD0000">"Printer&nbsp;'"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$dest&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">"'&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;"&nbsp;</span><span style="color: #007700">.<br /><a name="l155" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"printer&nbsp;name.&nbsp;Use&nbsp;local&nbsp;port&nbsp;(LPT1,&nbsp;COM1,&nbsp;etc)&nbsp;or&nbsp;smb://computer/printer&nbsp;notation."</span><span style="color: #007700">);<br /><a name="l156" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l157" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">buffer&nbsp;</span><span style="color: #007700">=&nbsp;array();<br /><a name="l158" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l159" /><br /><a name="l160" />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">__destruct</span><span style="color: #007700">()<br /><a name="l161" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l162" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">buffer&nbsp;</span><span style="color: #007700">!==&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br /><a name="l163" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">trigger_error</span><span style="color: #007700">(</span><span style="color: #DD0000">"Print&nbsp;connector&nbsp;was&nbsp;not&nbsp;finalized.&nbsp;Did&nbsp;you&nbsp;forget&nbsp;to&nbsp;close&nbsp;the&nbsp;printer?"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">E_USER_NOTICE</span><span style="color: #007700">);<br /><a name="l164" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l165" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l166" /><br /><a name="l167" />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">finalize</span><span style="color: #007700">()<br /><a name="l168" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l169" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$data&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">implode</span><span style="color: #007700">(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">buffer</span><span style="color: #007700">);<br /><a name="l170" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">buffer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br /><a name="l171" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">platform&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">PLATFORM_WIN</span><span style="color: #007700">)&nbsp;{<br /><a name="l172" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">finalizeWin</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br /><a name="l173" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">platform&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">PLATFORM_LINUX</span><span style="color: #007700">)&nbsp;{<br /><a name="l174" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">finalizeLinux</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br /><a name="l175" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><a name="l176" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">finalizeMac</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br /><a name="l177" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l178" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l179" /><br /><a name="l180" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l181" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Send&nbsp;job&nbsp;to&nbsp;printer&nbsp;--&nbsp;platform-specific&nbsp;Linux&nbsp;code.<br /><a name="l182" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l183" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data&nbsp;Print&nbsp;data<br /><a name="l184" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;Exception<br /><a name="l185" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l186" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">protected&nbsp;function&nbsp;</span><span style="color: #0000BB">finalizeLinux</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">)<br /><a name="l187" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l188" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Non-Windows&nbsp;samba&nbsp;printing&nbsp;*/<br /><a name="l189" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$device&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"//"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">hostname&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">"/"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">printerName</span><span style="color: #007700">;<br /><a name="l190" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">userName&nbsp;</span><span style="color: #007700">!==&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br /><a name="l191" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$user&nbsp;</span><span style="color: #007700">=&nbsp;(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">workgroup&nbsp;</span><span style="color: #007700">!=&nbsp;</span><span style="color: #0000BB">null&nbsp;</span><span style="color: #007700">?&nbsp;(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">workgroup&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">"\\"</span><span style="color: #007700">)&nbsp;:&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">userName</span><span style="color: #007700">;<br /><a name="l192" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">userPassword&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br /><a name="l193" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;No&nbsp;password<br /><a name="l194" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$command&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(<br /><a name="l195" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"smbclient&nbsp;%s&nbsp;-U&nbsp;%s&nbsp;-c&nbsp;%s&nbsp;-N"</span><span style="color: #007700">,<br /><a name="l196" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$device</span><span style="color: #007700">),<br /><a name="l197" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$user</span><span style="color: #007700">),<br /><a name="l198" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #DD0000">"print&nbsp;-"</span><span style="color: #007700">)<br /><a name="l199" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l200" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$redactedCommand&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$command</span><span style="color: #007700">;<br /><a name="l201" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><a name="l202" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;With&nbsp;password<br /><a name="l203" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$command&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(<br /><a name="l204" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"smbclient&nbsp;%s&nbsp;%s&nbsp;-U&nbsp;%s&nbsp;-c&nbsp;%s"</span><span style="color: #007700">,<br /><a name="l205" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$device</span><span style="color: #007700">),<br /><a name="l206" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">userPassword</span><span style="color: #007700">),<br /><a name="l207" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$user</span><span style="color: #007700">),<br /><a name="l208" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #DD0000">"print&nbsp;-"</span><span style="color: #007700">)<br /><a name="l209" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l210" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$redactedCommand&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(<br /><a name="l211" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"smbclient&nbsp;%s&nbsp;%s&nbsp;-U&nbsp;%s&nbsp;-c&nbsp;%s"</span><span style="color: #007700">,<br /><a name="l212" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$device</span><span style="color: #007700">),<br /><a name="l213" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #DD0000">"*****"</span><span style="color: #007700">),<br /><a name="l214" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$user</span><span style="color: #007700">),<br /><a name="l215" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #DD0000">"print&nbsp;-"</span><span style="color: #007700">)<br /><a name="l216" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l217" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l218" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><a name="l219" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;No&nbsp;authentication&nbsp;information&nbsp;at&nbsp;all<br /><a name="l220" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$command&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(<br /><a name="l221" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"smbclient&nbsp;%s&nbsp;-c&nbsp;%s&nbsp;-N"</span><span style="color: #007700">,<br /><a name="l222" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$device</span><span style="color: #007700">),<br /><a name="l223" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #DD0000">"print&nbsp;-"</span><span style="color: #007700">)<br /><a name="l224" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l225" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$redactedCommand&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$command</span><span style="color: #007700">;<br /><a name="l226" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l227" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$retval&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">runCommand</span><span style="color: #007700">(</span><span style="color: #0000BB">$command</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$outputStr</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$errorStr</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br /><a name="l228" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$retval&nbsp;</span><span style="color: #007700">!=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&nbsp;{<br /><a name="l229" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000BB">Exception</span><span style="color: #007700">(</span><span style="color: #DD0000">"Failed&nbsp;to&nbsp;print.&nbsp;Command&nbsp;\"</span><span style="color: #0000BB">$redactedCommand</span><span style="color: #DD0000">\"&nbsp;"&nbsp;</span><span style="color: #007700">.<br /><a name="l230" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"failed&nbsp;with&nbsp;exit&nbsp;code&nbsp;</span><span style="color: #0000BB">$retval</span><span style="color: #DD0000">:&nbsp;"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">trim</span><span style="color: #007700">(</span><span style="color: #0000BB">$outputStr</span><span style="color: #007700">));<br /><a name="l231" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l232" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l233" /><br /><a name="l234" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l235" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Send&nbsp;job&nbsp;to&nbsp;printer&nbsp;--&nbsp;platform-specific&nbsp;Mac&nbsp;code.<br /><a name="l236" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l237" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data&nbsp;Print&nbsp;data<br /><a name="l238" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@throws&nbsp;Exception<br /><a name="l239" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l240" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">protected&nbsp;function&nbsp;</span><span style="color: #0000BB">finalizeMac</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">)<br /><a name="l241" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l242" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000BB">Exception</span><span style="color: #007700">(</span><span style="color: #DD0000">"Mac&nbsp;printing&nbsp;not&nbsp;implemented."</span><span style="color: #007700">);<br /><a name="l243" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l244" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l245" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l246" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Send&nbsp;data&nbsp;to&nbsp;printer&nbsp;--&nbsp;platform-specific&nbsp;Windows&nbsp;code.<br /><a name="l247" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l248" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data<br /><a name="l249" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l250" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">protected&nbsp;function&nbsp;</span><span style="color: #0000BB">finalizeWin</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">)<br /><a name="l251" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l252" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Windows-friendly&nbsp;printing&nbsp;of&nbsp;all&nbsp;sorts&nbsp;*/<br /><a name="l253" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">isLocal</span><span style="color: #007700">)&nbsp;{<br /><a name="l254" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Networked&nbsp;printing&nbsp;*/<br /><a name="l255" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$device&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"\\\\"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">hostname&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">"\\"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">printerName</span><span style="color: #007700">;<br /><a name="l256" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">userName&nbsp;</span><span style="color: #007700">!==&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br /><a name="l257" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Log&nbsp;in&nbsp;*/<br /><a name="l258" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$user&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"/user:"&nbsp;</span><span style="color: #007700">.&nbsp;(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">workgroup&nbsp;</span><span style="color: #007700">!=&nbsp;</span><span style="color: #0000BB">null&nbsp;</span><span style="color: #007700">?&nbsp;(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">workgroup&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">"\\"</span><span style="color: #007700">)&nbsp;:&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">userName</span><span style="color: #007700">;<br /><a name="l259" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">userPassword&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br /><a name="l260" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$command&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(<br /><a name="l261" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"net&nbsp;use&nbsp;%s&nbsp;%s"</span><span style="color: #007700">,<br /><a name="l262" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$device</span><span style="color: #007700">),<br /><a name="l263" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$user</span><span style="color: #007700">)<br /><a name="l264" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l265" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$redactedCommand&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$command</span><span style="color: #007700">;<br /><a name="l266" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><a name="l267" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$command&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(<br /><a name="l268" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"net&nbsp;use&nbsp;%s&nbsp;%s&nbsp;%s"</span><span style="color: #007700">,<br /><a name="l269" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$device</span><span style="color: #007700">),<br /><a name="l270" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$user</span><span style="color: #007700">),<br /><a name="l271" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">userPassword</span><span style="color: #007700">)<br /><a name="l272" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l273" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$redactedCommand&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(<br /><a name="l274" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"net&nbsp;use&nbsp;%s&nbsp;%s&nbsp;%s"</span><span style="color: #007700">,<br /><a name="l275" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$device</span><span style="color: #007700">),<br /><a name="l276" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #0000BB">$user</span><span style="color: #007700">),<br /><a name="l277" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">escapeshellarg</span><span style="color: #007700">(</span><span style="color: #DD0000">"*****"</span><span style="color: #007700">)<br /><a name="l278" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l279" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l280" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$retval&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">runCommand</span><span style="color: #007700">(</span><span style="color: #0000BB">$command</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$outputStr</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$errorStr</span><span style="color: #007700">);<br /><a name="l281" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$retval&nbsp;</span><span style="color: #007700">!=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">)&nbsp;{<br /><a name="l282" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000BB">Exception</span><span style="color: #007700">(</span><span style="color: #DD0000">"Failed&nbsp;to&nbsp;print.&nbsp;Command&nbsp;\"</span><span style="color: #0000BB">$redactedCommand</span><span style="color: #DD0000">\"&nbsp;"&nbsp;</span><span style="color: #007700">.<br /><a name="l283" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"failed&nbsp;with&nbsp;exit&nbsp;code&nbsp;</span><span style="color: #0000BB">$retval</span><span style="color: #DD0000">:&nbsp;"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">trim</span><span style="color: #007700">(</span><span style="color: #0000BB">$errorStr</span><span style="color: #007700">));<br /><a name="l284" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l285" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l286" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Final&nbsp;print-out&nbsp;*/<br /><a name="l287" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$filename&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">tempnam</span><span style="color: #007700">(</span><span style="color: #0000BB">sys_get_temp_dir</span><span style="color: #007700">(),&nbsp;</span><span style="color: #DD0000">"escpos"</span><span style="color: #007700">);<br /><a name="l288" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">file_put_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$filename</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br /><a name="l289" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">runCopy</span><span style="color: #007700">(</span><span style="color: #0000BB">$filename</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$device</span><span style="color: #007700">))&nbsp;{<br /><a name="l290" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000BB">Exception</span><span style="color: #007700">(</span><span style="color: #DD0000">"Failed&nbsp;to&nbsp;copy&nbsp;file&nbsp;to&nbsp;printer"</span><span style="color: #007700">);<br /><a name="l291" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l292" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$filename</span><span style="color: #007700">);<br /><a name="l293" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><a name="l294" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Drop&nbsp;data&nbsp;straight&nbsp;on&nbsp;the&nbsp;printer&nbsp;*/<br /><a name="l295" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">runWrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">printerName</span><span style="color: #007700">))&nbsp;{<br /><a name="l296" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;</span><span style="color: #0000BB">Exception</span><span style="color: #007700">(</span><span style="color: #DD0000">"Failed&nbsp;to&nbsp;write&nbsp;file&nbsp;to&nbsp;printer&nbsp;at&nbsp;"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">printerName</span><span style="color: #007700">);<br /><a name="l297" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l298" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l299" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l300" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l301" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l302" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string&nbsp;Current&nbsp;platform.&nbsp;Separated&nbsp;out&nbsp;for&nbsp;testing&nbsp;purposes.<br /><a name="l303" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l304" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">protected&nbsp;function&nbsp;</span><span style="color: #0000BB">getCurrentPlatform</span><span style="color: #007700">()<br /><a name="l305" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l306" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">PHP_OS&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #DD0000">"WINNT"</span><span style="color: #007700">)&nbsp;{<br /><a name="l307" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">PLATFORM_WIN</span><span style="color: #007700">;<br /><a name="l308" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l309" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">PHP_OS&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #DD0000">"Darwin"</span><span style="color: #007700">)&nbsp;{<br /><a name="l310" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">PLATFORM_MAC</span><span style="color: #007700">;<br /><a name="l311" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l312" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">PLATFORM_LINUX</span><span style="color: #007700">;<br /><a name="l313" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l314" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l315" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;(non-PHPdoc)<br /><a name="l316" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@see&nbsp;PrintConnector::read()<br /><a name="l317" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l318" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">read</span><span style="color: #007700">(</span><span style="color: #0000BB">$len</span><span style="color: #007700">)<br /><a name="l319" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l320" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Two-way&nbsp;communication&nbsp;is&nbsp;not&nbsp;supported&nbsp;*/<br /><a name="l321" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">return&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">;<br /><a name="l322" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l323" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l324" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l325" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Run&nbsp;a&nbsp;command,&nbsp;pass&nbsp;it&nbsp;data,&nbsp;and&nbsp;retrieve&nbsp;its&nbsp;return&nbsp;value,&nbsp;standard&nbsp;output,&nbsp;and&nbsp;standard&nbsp;error.<br /><a name="l326" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l327" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$command&nbsp;the&nbsp;command&nbsp;to&nbsp;run.<br /><a name="l328" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$outputStr&nbsp;variable&nbsp;to&nbsp;fill&nbsp;with&nbsp;standard&nbsp;output.<br /><a name="l329" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$errorStr&nbsp;variable&nbsp;to&nbsp;fill&nbsp;with&nbsp;standard&nbsp;error.<br /><a name="l330" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$inputStr&nbsp;text&nbsp;to&nbsp;pass&nbsp;to&nbsp;the&nbsp;command's&nbsp;standard&nbsp;input&nbsp;(optional).<br /><a name="l331" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;number<br /><a name="l332" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l333" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">protected&nbsp;function&nbsp;</span><span style="color: #0000BB">runCommand</span><span style="color: #007700">(</span><span style="color: #0000BB">$command</span><span style="color: #007700">,&nbsp;&amp;</span><span style="color: #0000BB">$outputStr</span><span style="color: #007700">,&nbsp;&amp;</span><span style="color: #0000BB">$errorStr</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$inputStr&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)<br /><a name="l334" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l335" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$descriptors&nbsp;</span><span style="color: #007700">=&nbsp;array(<br /><a name="l336" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">0&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">"pipe"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"r"</span><span style="color: #007700">),<br /><a name="l337" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">1&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">"pipe"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"w"</span><span style="color: #007700">),<br /><a name="l338" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">2&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">"pipe"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"w"</span><span style="color: #007700">),<br /><a name="l339" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br /><a name="l340" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$process&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">proc_open</span><span style="color: #007700">(</span><span style="color: #0000BB">$command</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$descriptors</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$fd</span><span style="color: #007700">);<br /><a name="l341" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">is_resource</span><span style="color: #007700">(</span><span style="color: #0000BB">$process</span><span style="color: #007700">))&nbsp;{<br /><a name="l342" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Write&nbsp;to&nbsp;input&nbsp;*/<br /><a name="l343" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$inputStr&nbsp;</span><span style="color: #007700">!==&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br /><a name="l344" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fd</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">],&nbsp;</span><span style="color: #0000BB">$inputStr</span><span style="color: #007700">);<br /><a name="l345" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l346" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fd</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]);<br /><a name="l347" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Read&nbsp;stdout&nbsp;*/<br /><a name="l348" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$outputStr&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">stream_get_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$fd</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">]);<br /><a name="l349" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fd</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">]);<br /><a name="l350" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Read&nbsp;stderr&nbsp;*/<br /><a name="l351" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$errorStr&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">stream_get_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$fd</span><span style="color: #007700">[</span><span style="color: #0000BB">2</span><span style="color: #007700">]);<br /><a name="l352" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fd</span><span style="color: #007700">[</span><span style="color: #0000BB">2</span><span style="color: #007700">]);<br /><a name="l353" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Finish&nbsp;up&nbsp;*/<br /><a name="l354" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$retval&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">proc_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$process</span><span style="color: #007700">);<br /><a name="l355" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$retval</span><span style="color: #007700">;<br /><a name="l356" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br /><a name="l357" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Method&nbsp;calling&nbsp;this&nbsp;should&nbsp;notice&nbsp;a&nbsp;non-zero&nbsp;exit&nbsp;and&nbsp;print&nbsp;an&nbsp;error&nbsp;*/<br /><a name="l358" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">return&nbsp;-</span><span style="color: #0000BB">1</span><span style="color: #007700">;<br /><a name="l359" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l360" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l361" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l362" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l363" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Copy&nbsp;a&nbsp;file.&nbsp;Separated&nbsp;out&nbsp;so&nbsp;that&nbsp;nothing&nbsp;is&nbsp;actually&nbsp;printed&nbsp;during&nbsp;test&nbsp;runs.<br /><a name="l364" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l365" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$from&nbsp;Source&nbsp;file<br /><a name="l366" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$to&nbsp;Destination&nbsp;file<br /><a name="l367" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;boolean&nbsp;True&nbsp;if&nbsp;copy&nbsp;was&nbsp;successful,&nbsp;false&nbsp;otherwise<br /><a name="l368" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l369" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">protected&nbsp;function&nbsp;</span><span style="color: #0000BB">runCopy</span><span style="color: #007700">(</span><span style="color: #0000BB">$from</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$to</span><span style="color: #007700">)<br /><a name="l370" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l371" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">copy</span><span style="color: #007700">(</span><span style="color: #0000BB">$from</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$to</span><span style="color: #007700">);<br /><a name="l372" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l373" />&nbsp;&nbsp;&nbsp;&nbsp;<br /><a name="l374" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br /><a name="l375" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Write&nbsp;data&nbsp;to&nbsp;a&nbsp;file.&nbsp;Separated&nbsp;out&nbsp;so&nbsp;that&nbsp;nothing&nbsp;is&nbsp;actually&nbsp;printed&nbsp;during&nbsp;test&nbsp;runs.<br /><a name="l376" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*<br /><a name="l377" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$data&nbsp;Data&nbsp;to&nbsp;print<br /><a name="l378" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$to&nbsp;Destination&nbsp;file<br /><a name="l379" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;boolean&nbsp;True&nbsp;if&nbsp;write&nbsp;was&nbsp;successful,&nbsp;false&nbsp;otherwise<br /><a name="l380" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br /><a name="l381" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">protected&nbsp;function&nbsp;</span><span style="color: #0000BB">runWrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$to</span><span style="color: #007700">)<br /><a name="l382" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l383" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">file_put_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$to</span><span style="color: #007700">)&nbsp;!==&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">;<br /><a name="l384" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l385" /><br /><a name="l386" />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">write</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">)<br /><a name="l387" />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><a name="l388" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">buffer</span><span style="color: #007700">[]&nbsp;=&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">;<br /><a name="l389" />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><a name="l390" />}<br /><a name="l391" /></span>
</span>